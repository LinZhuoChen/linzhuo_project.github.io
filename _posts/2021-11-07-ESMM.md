---
title: SIGIR’2018｜经典CVR模型ESMM详解
categories: graph embedding
tags:
- 推荐系统
---

大家好，今天给大家带来阿里妈妈团队发表在SIGIR’2018 的论文：《Entire Space Multi-Task Model: An Effective Approach for Estimating Post-Click Conversion Rate》。该文章提出了ESMM模型，旨在解决CVR预估任务中出现的样本选择偏差与稀疏问题。是一篇十分经典的论文。


## 1. 动机与介绍

目前应用在CVR任务的模型存在以下两种问题：

1. 如图1. 所示，传统的CVR模型只在click = 1的样本上训练，然而在推断过程中却需要在整个样本空间上进行推断。这种做法引入了**样本选择偏差**。
2. **数据稀疏问题**：CVR模型由于在点击为1的样本上进行训练，相比于CTR任务，训练数据大大减少。

![](/images/data_bias.png)
<center>图1. CVR任务中的样本偏差与数据稀疏问题</center>

为了解决上述问题：这篇文章中，提出了一种新颖的模型，名为Entire Space Multi- task Model (ESMM)。ESMM通过同时训练预测CTCVR(点击并支付的概率)和CTR（点击概率）的方式来间接的估计CVR（在点击的情况下用户支付的概率），而并非传统方法中，直接采集点击为1的数据来训练预估CVR。这样，CTCVR和CTR在共享数据样本的同时，可以间接的推导出CVR(pCTCVR / CTR)，并避免了上述两种问题。具体细节我们将在下文阐述。

## 2. 方法介绍
我们令$X$为样本特征，$Y$为点击标签，$Z$为支付标签。CTR 和 CVR的任务可以由下列式子表示：


$$
CTR = p(y = 1 | x),
$$


$$
CVR = p(z = 1 | y=1, x)
$$


其中CTR任务在样本空间$X$上即可训练预估得到，然而CVR任务则需要在$y=1, x$的空间上进行训练。因此，相较于CTR任务，CVR任务引入了**数据稀疏**和样本**选择偏差**的问题。

ESMM通过监督训练CTCVR与CTR，来间接的得到CVR，可以有效的避免在CVR任务中引入上述问题。CTCVR任务可以由下列式子得到：


$$
CTCVR = p(z = 1 , y = 1| x), CTCVR = CVR \times CTR.
$$


我们可以发现，和CTR任务一样，CTCVR在样本空间$X$上即可训练预估得到。因此，我们只需要建立一个模型，共享样本空间的情况下，同时预估CTR与CTCVR，即可有效的预估CVR，避免在CVR任务中引入**数据稀疏**和样本**选择偏差**问题。

ESMM的网络结构如图2所示：其中图2中绿点为监督信号，粉点(CVR)为网络中的一个变量，没有引入监督信号。我们可以看到，ESMM通过同时训练pCTR与pCTCVR，来间接的预估CVR。由于pCTR与pCTCVR可以共享样本空间，因此不会在CVR任务中引入稀疏和偏差问题。


![](/images/ESMM.png)

<center>图2. ESMM网络架构</center>

这里有一个模型设计的小细节，为什么不单独训练两个独立的模型分别预测pCTCVR与pCTR，相除得到pCVR。而是要采用图2中的级联相乘方法？
原因是：pCTR一般是一个很小的浮点数，如果单独训练两个独立的模型分别预测pCTCVR与pCTR，然后pCTCVR / pCTR = pCVR，会引入数值不稳定问题。如果采用图2中的级联相乘结构，我们只需从main task 中取得CVR即可，避免了除法操作引入的数值不稳定问题。

ESMM架构的损失函数如下所示：


$$
L(\theta_{cvr}, \theta_{ctr}) = \sum_{i=1}^N l(y_i, f(x_i; \theta_{ctr})) + \sum_{i=1}^N l(y_i \& z_i, f(x_i;\theta_{ctr}) \times f(x_i; \theta_{cvr}))
$$


其中$l(.)$为交叉熵损失函数。同时，在ESMM架构中，由于embedding层占据了主要的参数量，因此CVR任务与CTR任务共享embedding表示。这样同时也缓解了CVR任务数据稀疏的问题。

## 3.实验
由于目前没有CTCVR任务的公开数据集，因此，作者自己构建了一个基于淘宝的数据集(Product)。并与其他方法进行对比,实验结果如图3所示
：

![](/images/esmm_result1.png)
<center>图3.各方法在Product数据集上的表现。</center>

其中，BASE：图2中ESMM去掉CTR网络，AMAN：基于base网络，从未点击样本中随机抽样作为负例；OVERSAMPLING：对点击中的正例（支付）过采样；UNBIAS：使用rejection sampling；DIVISION：分别训练CTR和CVCTR，相除得到pCVR，对应章节2中的问题；ESMM-NS：ESMM结构中CVR与CTR网络不共享 embedding层。我们可以看到。ESMM取得了最好的结果。

文章中接着比较了不同方法在各个采样率情况下在Product数据集上的表现。ESMM均取得了最好的结果。同时，各个方法随着采样率的增加，效果提升明显，这也说明了数据量的重要性。
![](/images/esmm_result2.png)
<center>图4.不同采样率下各方法在Product数据集上的表现。</center>

## 总结

ESMM通过引入CTR和CTCVR这个辅助任务，间接隐式地学习CVR，来解决CVR任务中**样本选择偏差**和**数据稀疏**问题。通过impression → click → conversion这条链路，指导了ESMM模型结构的设计。

## 参考文献
\[1\]: Ma, X., Zhao, L., Huang, G., Wang, Z., Hu, Z., Zhu, X. and Gai, K., 2018, June. Entire space multi-task model: An effective approach for estimating post-click conversion rate. In The 41st International ACM SIGIR Conference on Research & Development in Information Retrieval (pp. 1137-1140).

\[2\]: https://zhuanlan.zhihu.com/p/57481330


